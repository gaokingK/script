# link:
- https://www.liujiangblog.com/course/python/83
# 非阻塞代码
- 非阻塞代码指的是代码执行时程序或者执行线程挂起等待某个操作（特别是长时间操作如网络请求，I/O操作）这种代码允许在等待某个操作完成的同时，继续执行其他任务或者处理其他请求

### 阻塞 vs 非阻塞
- **阻塞操作**指的是某个操作必须完成，才能继续执行下一条指令。例如，当程序执行到一个文件读取操作时，它会停在那里，直到文件内容被完全读取。在这期间，程序不能做任何其他的事情。
- **非阻塞操作**，相反，意味着即使操作尚未完成，程序也可以继续执行下一个任务。这通常涉及异步I/O、协程、事件循环和回调函数等技术，以便在等待外部操作（如数据库交互或网络通信）时，可以释放资源处理其他任务。

### 非阻塞代码的优势
- **提高性能和响应速度**：由于执行线程不会因为等待操作而挂起，非阻塞I/O或非阻塞编程模型能够让程序在单个线程内高效地管理多个任务，从而提高应用的性能和响应速度。
- **更好的资源利用**：非阻塞编程减少了线程的需求，因为单个线程可以处理多个任务。这意味着更少的线程切换和更高效的CPU使用。
- **提升用户体验**：在用户界面（UI）编程和网络编程中，非阻塞代码可以避免应用程序在等待操作时冻结，从而提供更平滑和响应更快的用户体验。

### 实现非阻塞代码的技术
- **事件循环和异步I/O**：许多现代编程语言和框架，如Node.js、Python的asyncio库、JavaScript的Promise和async/await，都采用了事件循环机制来支持非阻塞I/O操作。
- **协程**：协程提供了一个更易于理解和维护的方式来编写非阻塞代码。它允许以看似同步的方式编写代码，而实际上却能在I/O操作等待时，释放线程来执行其他协程。
- **回调函数**：在某些情况下，非阻塞操作通过注册回调函数来实现，当操作完成时，相应的回调函数被调用。

非阻塞编程模型在处理大量并发请求和高性能服务器应用程序中尤为重要，它能够显著提升效率和用户体验。然而，非阻塞编程也引入了额外的复杂性，特别是在错误处理和流程控制方面，这要求开发者需有较高的编程技巧。

# 抢占式调度和非抢占式调度
- 抢占式线程调度是一种操作系统的线程调度方式，这种方式会在cpu内核层面中断或者暂停当前cpu上执行的线程，将执行机会分配给其他线程；非抢占式线程调度是线程一旦获得了时间片，就会一直执行
- 抢占式线程调度是现代操作系统（如Windows、Linux等）广泛采用的线程调度方式，它通过强制中断机制保证系统处理的灵活性和高效性，但同时也因为频繁的上下文切换可能带来性能开销。
- 在抢占式调度中，操作系统的调度器会按照特定的算法（如轮转法、优先级调度法等）来决定哪个线程可以获得CPU时间，并且决策是在运行时动态发生的。每个线程都会获得一定的CPU时间片（time slice），一旦该时间片用完，如果其他线程等待执行，系统调度器就可以强行挂起当前线程，给其他线程分配CPU时间。
### 抢占式调度的关键特点：
时间片：系统为每个线程分配的执行时间。一旦时间片用完，不管任务是否完成，线程都会被挂起，以确保其他线程也有执行的机会。
公平性：每个线程都有获得CPU时间片的机会，这意味着即便是优先级较低的线程，也能定期获取执行时间。
上下文切换：切换当前运行线程至另一个线程的过程。包括保存当前线程的状态和恢复另一个线程的状态。
响应性：抢占式调度可以提高系统对实时事件的响应性，因为系统可以确保高优先级的线程可以及时获得处理器时间。
### 抢占式调度和非抢占式调度的比较：
- 抢占式：线程执行不能无限制进行。调度器可以强制从一个线程切换到另一个线程，从而实现系统资源的公平分配，并提高对共享资源访问的管理。
- 非抢占式（又称协作式）：线程一旦获得CPU，就会一直执行下去，直至线程自愿释放CPU（通常是因为I/O操作或达到预定的运行点）。这种非抢占方式可能导致低优先级或长时间任务阻塞系统，造成性能瓶颈。
# 零拷贝
在传统的数据传输中，数据可能在用户空间和内核态中多次复制，零拷贝是一种网络通信的优化技术，目的在于减少数据传输过程中数据拷贝的次数，提高数据传输效率，减小网络延迟

- 在讨论协程中的“零拷贝”（Zero-copy）之前，我们需要了解什么是“零拷贝”技术。零拷贝是一种计算机通信的优化技术，目标是在数据传输过程中减少CPU的拷贝操作，从而提高数据传输的效率，减少延迟，并提高系统的整体性能。在传统的数据传输操作中，数据可能需要在用户空间和内核空间之间多次复制，这些复制操作会增加CPU的负担和数据传输的延迟。
零拷贝技术试图通过减少这些不必要的数据复制来解决上述问题。在零拷贝技术的帮助下，数据可以直接在硬件（如网络接口）与应用程序之间传输，避免在内核空间和用户空间之间进行多余的复制。这样不仅减少了CPU的过度消耗，还降低了系统的上下文切换成本。
当我们把零拷贝概念应用到协程中时，目标仍然是提升性能和效率。协程是一种编程范式，可以更轻松地进行异步编程和并发处理。在协程框架下使用零拷贝技术，可以进一步减少协程之间数据传递的开销，特别是在高性能网络应用或文件处理应用中，这种优化显得尤为重要。例如，如果有协程负责从网络中读取数据，而另一个协程负责处理这些数据，零拷贝技术可以帮助有效地在这两个协程之间传递数据，而不会造成额外的复制开销。
结合协程的非阻塞特性和零拷贝技术，开发者可以构建出高效率、低延迟的应用程序。不过，需要注意的是，零拷贝技术的实现和优化通常涉及到操作系统级别的支持和网络/文件 IO的处理，因此在实际应用中需要具体问题具体分析。
